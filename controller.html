<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>KYKY RADIO â€” CONTRÃ”LEUR ATC</title>
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Rajdhani:wght@500;600;700&family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#07080a;--panel:#0f1113;--panel-b:#13161a;--panel-c:#1a1e24;
  --border:#232830;--border-hi:#363d48;
  --amber:#ffaa00;--amber-lo:#3d2800;--amber-mid:#8a5a00;
  --green:#00e647;--green-lo:#002d10;--green-dim:#006622;
  --red:#ff3333;--red-lo:#2d0808;
  --blue:#4488ff;
  --cyan:#00c8ff;--cyan-lo:#002d3a;
  --txt:#b8bec8;--txt-lo:#4a5060;--txt-mid:#7a8290;
  --lcd:#080f08;
}
*{margin:0;padding:0;box-sizing:border-box;}
html,body{height:100%;background:var(--bg);color:var(--txt);font-family:'Rajdhani',sans-serif;overflow:hidden;}
body::before{content:'';position:fixed;inset:0;pointer-events:none;z-index:9999;
  background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,.04) 2px,rgba(0,0,0,.04) 4px);}
.layout{display:flex;flex-direction:column;height:100%;}

.topbar{background:#090b0d;border-bottom:1px solid var(--border);padding:0 16px;height:42px;
  display:flex;align-items:center;gap:14px;flex-shrink:0;}
.logo{font-family:'Orbitron',monospace;font-size:14px;color:var(--amber);letter-spacing:4px;font-weight:700;}
.sep{width:1px;height:18px;background:var(--border);}
.topbar-sub{font-size:10px;color:var(--txt-lo);letter-spacing:3px;text-transform:uppercase;}
.topbar-right{margin-left:auto;font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--txt-lo);}

.main{flex:1;display:flex;gap:12px;padding:12px;overflow:hidden;}

.card{background:var(--panel);border:1px solid var(--border);border-radius:5px;
  display:flex;flex-direction:column;overflow:hidden;}
.card-head{background:#0b0d0f;border-bottom:1px solid var(--border);padding:6px 12px;
  font-size:10px;font-weight:700;letter-spacing:3px;color:var(--txt-lo);text-transform:uppercase;flex-shrink:0;}

/* â”€â”€ COL LEFT â”€â”€ */
.col-left{width:230px;flex-shrink:0;display:flex;flex-direction:column;gap:12px;}

.pos-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:1px;background:var(--border);}
.pos-btn{background:var(--panel);border:none;padding:11px 4px;cursor:pointer;text-align:center;
  transition:background .15s;position:relative;}
.pos-btn:hover{background:var(--panel-c);}
.pos-btn.active{background:#0e1a0c;}
.pos-btn.active::after{content:'';position:absolute;bottom:0;left:0;right:0;height:2px;background:var(--green);}
.pos-code{font-family:'Orbitron',monospace;font-size:13px;font-weight:700;color:var(--txt-lo);}
.pos-btn.active .pos-code{color:var(--green);}
.pos-name{font-size:8px;color:var(--txt-lo);letter-spacing:1px;margin-top:2px;text-transform:uppercase;}
.pos-hz{font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--amber-lo);margin-top:3px;}
.pos-btn.active .pos-hz{color:var(--amber);}

.fg{padding:10px 12px;border-bottom:1px solid var(--border);}
.fl{font-size:9px;letter-spacing:2px;color:var(--txt-lo);text-transform:uppercase;margin-bottom:5px;font-weight:700;}
input.fi,select.fi{width:100%;background:#08090b;border:1px solid var(--border);border-radius:3px;
  padding:6px 9px;color:var(--amber);font-family:'Orbitron',monospace;font-size:11px;
  letter-spacing:2px;outline:none;text-transform:uppercase;}
input.fi::placeholder{color:var(--amber-lo);}
select.fi{color:var(--txt);font-family:'Rajdhani',sans-serif;font-size:12px;letter-spacing:0;cursor:pointer;}
.conn-btn{display:block;width:calc(100% - 20px);margin:10px;padding:10px;
  background:#0a160a;border:1px solid #1d3d1d;border-radius:3px;
  color:var(--green);font-family:'Orbitron',monospace;font-size:10px;letter-spacing:3px;
  cursor:pointer;transition:all .15s;text-transform:uppercase;}
.conn-btn:hover:not(:disabled){background:#102010;border-color:var(--green);}
.conn-btn.disc{background:#160a0a;border-color:#3d1d1d;color:var(--red);}
.conn-btn:disabled{opacity:.4;cursor:not-allowed;}

.users-panel{flex:1;overflow:hidden;}
.usr-scroll{overflow-y:auto;height:100%;}
.usr-row{padding:8px 12px;display:flex;align-items:center;gap:8px;border-bottom:1px solid var(--border);
  cursor:pointer;transition:background .12s;user-select:none;}
.usr-row:hover{background:var(--panel-c);}
.usr-dot{width:6px;height:6px;border-radius:50%;background:var(--green);box-shadow:0 0 6px var(--green);flex-shrink:0;}
.usr-name{font-family:'Orbitron',monospace;font-size:11px;color:var(--txt);}
.usr-hint{font-size:9px;color:var(--txt-lo);margin-top:1px;letter-spacing:1px;}
.no-users{padding:20px;text-align:center;color:var(--txt-lo);font-size:10px;letter-spacing:2px;}

/* â”€â”€ COL CENTER â”€â”€ */
.col-center{width:285px;flex-shrink:0;display:flex;flex-direction:column;gap:12px;}

.vhf-box{background:var(--panel-b);border:2px solid var(--border-hi);border-radius:7px;
  box-shadow:0 8px 32px rgba(0,0,0,.6),inset 0 1px 0 rgba(255,255,255,.04);}
.vhf-top{background:#090b0d;border-bottom:1px solid var(--border);padding:5px 10px;
  display:flex;justify-content:space-between;align-items:center;}
.vhf-brand{font-family:'Orbitron',monospace;font-size:7px;letter-spacing:3px;color:var(--txt-lo);}
.lcd-wrap{margin:10px;background:var(--lcd);border-radius:3px;border:1px solid #0a180a;
  box-shadow:inset 0 2px 12px rgba(0,0,0,.7);padding:8px 12px;}
.lcd-top{display:flex;align-items:baseline;gap:5px;justify-content:center;}
.lcd-freq{font-family:'Share Tech Mono',monospace;font-size:32px;color:var(--amber);letter-spacing:3px;
  text-shadow:0 0 20px rgba(255,170,0,.5);transition:all .3s;}
.lcd-freq.off{color:var(--amber-lo);text-shadow:none;}
.lcd-unit{font-family:'Rajdhani',sans-serif;font-size:10px;color:var(--amber-mid);align-self:flex-end;padding-bottom:3px;}
.lcd-pos{text-align:center;font-family:'Orbitron',monospace;font-size:8px;color:var(--txt-lo);letter-spacing:3px;margin-top:3px;}

.indics{display:flex;gap:7px;margin:0 10px 10px;}
.indic{flex:1;background:#0a0c0e;border:1px solid var(--border);border-radius:3px;
  padding:6px 7px;display:flex;align-items:center;gap:7px;}
.led{width:9px;height:9px;border-radius:50%;flex-shrink:0;transition:background .08s,box-shadow .08s;}
.led-r{background:var(--red-lo);}
.led-g{background:var(--green-lo);}
.led-r.on{background:var(--red);box-shadow:0 0 8px var(--red);}
.led-g.on{background:var(--green);box-shadow:0 0 8px var(--green);}
.led-lbl{font-family:'Orbitron',monospace;font-size:8px;letter-spacing:1px;color:var(--txt-lo);font-weight:700;}
.led-who{font-size:8px;color:var(--txt-lo);margin-left:auto;font-family:'Share Tech Mono',monospace;
  max-width:70px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}

.tx-banner{display:none;margin:0 10px 8px;padding:5px 8px;background:rgba(255,51,51,.08);
  border:1px solid rgba(255,51,51,.25);border-radius:3px;font-family:'Orbitron',monospace;
  font-size:8px;color:var(--red);letter-spacing:2px;text-align:center;
  animation:blink-tx 1.2s step-start infinite;}
.tx-banner.show{display:block;}
@keyframes blink-tx{50%{opacity:.4;}}

.ptt-wrap{margin:0 10px 12px;}
.ptt-btn{width:100%;padding:13px;background:#140e0e;border:2px solid #2e1818;border-radius:4px;
  color:#884444;font-family:'Orbitron',monospace;font-size:10px;letter-spacing:3px;
  cursor:pointer;transition:all .05s;user-select:none;text-transform:uppercase;}
.ptt-btn:not(.locked):not(:disabled):hover{border-color:#553333;color:#aa5555;}
.ptt-btn.tx{background:#1c0808;border-color:var(--red);color:var(--red);box-shadow:0 0 20px rgba(255,51,51,.2);}
.ptt-btn.locked,.ptt-btn:disabled{opacity:.45;cursor:not-allowed;}
.ptt-hint{text-align:center;font-size:9px;color:var(--txt-lo);margin-top:4px;letter-spacing:2px;}

/* â”€â”€ COL RIGHT â”€â”€ */
.col-right{flex:1;display:flex;flex-direction:column;gap:12px;min-width:0;overflow:hidden;}

.pos-row-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:1px;background:var(--border);}
.pos-card{background:var(--panel);padding:10px 12px;display:flex;align-items:center;gap:8px;}
.pos-dot2{width:7px;height:7px;border-radius:50%;background:var(--green-lo);flex-shrink:0;transition:all .3s;}
.pos-dot2.on{background:var(--green);box-shadow:0 0 7px var(--green);}
.pos-card-info{flex:1;}
.pos-card-call{font-family:'Orbitron',monospace;font-size:11px;color:var(--txt-lo);}
.pos-card-call.on{color:var(--green);}
.pos-card-sub{font-size:10px;color:var(--txt-lo);margin-top:1px;}
.pos-card-freq{font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--amber);
  background:var(--lcd);border:1px solid var(--border);padding:2px 6px;border-radius:2px;}

.chat-panel{flex:1;display:flex;flex-direction:column;overflow:hidden;}
.chat-msgs{flex:1;overflow-y:auto;padding:4px 0;}
.chat-msgs::-webkit-scrollbar{width:4px;}
.chat-msgs::-webkit-scrollbar-thumb{background:var(--border-hi);border-radius:2px;}
.msg{padding:4px 12px;display:flex;gap:8px;align-items:flex-start;}
.msg:hover{background:rgba(255,255,255,.02);}
.msg-time{font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--txt-lo);flex-shrink:0;padding-top:2px;}
.msg-name{font-family:'Orbitron',monospace;font-size:10px;font-weight:700;flex-shrink:0;}
.n-me{color:var(--amber);} .n-ctrl{color:var(--green);} .n-user{color:var(--blue);} .n-sys{color:var(--txt-lo);}
.msg-text{font-size:12px;color:var(--txt);line-height:1.4;word-break:break-word;}
.t-red{color:var(--red);font-weight:700;} .t-green{color:var(--green);font-weight:700;}
.sys-line .msg-text{font-size:10px;color:var(--txt-lo);font-style:italic;}

.chat-input-row{border-top:1px solid var(--border);padding:8px 10px;display:flex;gap:8px;flex-shrink:0;}
.chat-in{flex:1;background:#08090b;border:1px solid var(--border);border-radius:3px;
  padding:7px 10px;color:var(--txt);font-family:'Rajdhani',sans-serif;font-size:13px;outline:none;}
.chat-in::placeholder{color:var(--txt-lo);}
.chat-in:focus{border-color:var(--border-hi);}
.chat-in:disabled{opacity:.4;}
.chat-send{background:#0a160a;border:1px solid #1d3d1d;border-radius:3px;
  padding:7px 12px;color:var(--green);font-family:'Orbitron',monospace;font-size:9px;
  letter-spacing:2px;cursor:pointer;transition:all .15s;white-space:nowrap;}
.chat-send:hover:not(:disabled){background:#102010;border-color:var(--green);}
.chat-send:disabled{opacity:.4;cursor:not-allowed;}

/* â”€â”€ CONTEXT MENU â”€â”€ */
.ctx-menu{position:fixed;background:#111318;border:1px solid var(--border-hi);border-radius:5px;
  z-index:10000;min-width:200px;box-shadow:0 8px 32px rgba(0,0,0,.85);overflow:visible;
  font-family:'Rajdhani',sans-serif;display:none;}
.ctx-hdr{padding:6px 12px;font-size:9px;letter-spacing:2px;color:var(--amber);
  text-transform:uppercase;border-bottom:1px solid var(--border);background:#0d0f12;
  font-weight:700;border-radius:5px 5px 0 0;}
.ctx-item{padding:9px 14px;cursor:pointer;display:flex;align-items:center;gap:9px;font-size:13px;transition:background .1s;}
.ctx-item:hover{background:var(--panel-c);}
.ctx-item.danger{color:var(--red);}
.ctx-item.xfer{color:var(--green);}
.ctx-ico{font-size:11px;width:14px;text-align:center;}
.ctx-ico-arrow{font-size:10px;margin-left:auto;color:var(--txt-lo);}
.ctx-sep{height:1px;background:var(--border);margin:3px 0;}
/* Hover submenu */
.xfer-wrap{position:relative;}
.xfer-wrap .ctx-sub{
  display:none;position:absolute;left:100%;top:-1px;
  background:#111318;border:1px solid var(--border-hi);border-radius:5px;
  min-width:210px;box-shadow:8px 8px 32px rgba(0,0,0,.85);overflow:hidden;
}
.xfer-wrap:hover .ctx-sub{display:block;}
.ctx-sub-item{padding:9px 14px;cursor:pointer;font-size:13px;color:var(--green);
  transition:background .1s;display:flex;align-items:center;gap:8px;}
.ctx-sub-item:hover{background:var(--panel-c);}
.ctx-sub-item.off{color:var(--txt-lo);cursor:default;pointer-events:none;}
.ctx-sub-dot{width:6px;height:6px;border-radius:50%;background:var(--green);box-shadow:0 0 5px var(--green);flex-shrink:0;}
.ctx-sub-info{flex:1;}
.ctx-sub-call{font-family:'Orbitron',monospace;font-size:10px;font-weight:700;}
.ctx-sub-freq{font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--amber);}

/* â”€â”€ GLOBAL USERS â”€â”€ */
.glob-panel{flex-shrink:0;max-height:220px;}
.glob-scroll{overflow-y:auto;flex:1;}
.glob-scroll::-webkit-scrollbar{width:4px;}
.glob-scroll::-webkit-scrollbar-thumb{background:var(--border-hi);border-radius:2px;}
.glob-row{padding:7px 12px;display:flex;align-items:center;gap:9px;border-bottom:1px solid var(--border);
  cursor:pointer;transition:background .12s;user-select:none;}
.glob-row:hover{background:var(--panel-c);}
.glob-dot{width:6px;height:6px;border-radius:50%;background:var(--green);box-shadow:0 0 5px var(--green);flex-shrink:0;}
.glob-info{flex:1;min-width:0;}
.glob-name{font-family:'Orbitron',monospace;font-size:11px;color:var(--txt);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.glob-freq{font-size:9px;color:var(--txt-lo);margin-top:1px;font-family:'Share Tech Mono',monospace;}
.glob-badge{font-family:'Orbitron',monospace;font-size:8px;padding:2px 5px;border-radius:2px;
  background:var(--green-lo);color:var(--green);border:1px solid var(--green-dim);flex-shrink:0;}
.glob-badge.unicom{background:var(--cyan-lo,#002d3a);color:#00c8ff;border-color:#005566;}
.no-glob{padding:16px;text-align:center;color:var(--txt-lo);font-size:10px;letter-spacing:2px;}
.glob-count{margin-left:auto;font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--txt-lo);}

.statusbar{background:#06070a;border-top:1px solid var(--border);padding:4px 16px;display:flex;gap:16px;flex-shrink:0;}
.si{display:flex;align-items:center;gap:6px;font-size:10px;color:var(--txt-lo);letter-spacing:1px;}
.sdot{width:5px;height:5px;border-radius:50%;background:#1a1e24;transition:background .3s;}
.sdot.ok{background:var(--green);}
</style>
</head>
<body>
<div class="layout">
  <div class="topbar">
    <span class="logo">KYKY</span><div class="sep"></div>
    <span class="topbar-sub">Station de ContrÃ´le ATC</span>
    <div class="topbar-right" id="uidLabel"></div>
  </div>

  <div class="main">
    <!-- COL LEFT -->
    <div class="col-left">
      <div class="card">
        <div class="card-head">Gestionnaire de connexion</div>
        <div class="pos-grid">
          <button class="pos-btn" data-pos="CTY" data-freq="118.800" onclick="selectPos(this)">
            <div class="pos-code">CTY</div><div class="pos-name">City</div><div class="pos-hz">118.800</div>
          </button>
          <button class="pos-btn" data-pos="WLD" data-freq="123.500" onclick="selectPos(this)">
            <div class="pos-code">WLD</div><div class="pos-name">World</div><div class="pos-hz">123.500</div>
          </button>
          <button class="pos-btn" data-pos="ARL" data-freq="124.615" onclick="selectPos(this)">
            <div class="pos-code">ARL</div><div class="pos-name">Aerial</div><div class="pos-hz">124.615</div>
          </button>
        </div>
        <div class="fg"><div class="fl">Callsign</div><input class="fi" id="callsignInput" placeholder="KYKY_CTY" maxlength="12"></div>
        <div class="fg"><div class="fl">EntrÃ©e Micro</div><select class="fi" id="inDev"></select></div>
        <div class="fg" style="border-bottom:none;"><div class="fl">Sortie Audio</div><select class="fi" id="outDev"></select></div>
        <button class="conn-btn" id="connBtn" disabled onclick="toggleConn()">Se Connecter</button>
      </div>
      <div class="card users-panel">
        <div class="card-head">ConnectÃ©s sur ma frÃ©quence</div>
        <div class="usr-scroll" id="usrList"><div class="no-users">Non connectÃ©</div></div>
      </div>
    </div>

    <!-- COL CENTER -->
    <div class="col-center">
      <div class="vhf-box">
        <div class="vhf-top">
          <span class="vhf-brand">VHF COM â€” TRANSCEIVER</span>
          <span class="vhf-brand">KYKY-1000</span>
        </div>
        <div class="lcd-wrap">
          <div class="lcd-top"><div class="lcd-freq off" id="lcdFreq">---.---</div><div class="lcd-unit">MHz</div></div>
          <div class="lcd-pos" id="lcdPos">â€” NON CONNECTÃ‰ â€”</div>
        </div>
        <div class="tx-banner" id="txBanner">â— TX EN COURS</div>
        <div class="indics">
          <div class="indic"><div class="led led-r" id="ledExt"></div><div class="led-lbl">EXT</div><div class="led-who" id="extWho"></div></div>
          <div class="indic"><div class="led led-g" id="ledVous"></div><div class="led-lbl">VOUS</div></div>
        </div>
        <div class="ptt-wrap">
          <button class="ptt-btn" id="pttBtn" disabled onmousedown="startPTT()" onmouseup="stopPTT()" onmouseleave="stopPTT()">
            PTT â€” APPUYER POUR Ã‰METTRE
          </button>
          <div class="ptt-hint">ESPACE pour activer le PTT</div>
        </div>
      </div>
    </div>

    <!-- COL RIGHT -->
    <div class="col-right">
      <div class="card">
        <div class="card-head">Positions en ligne</div>
        <div class="pos-row-grid">
          <div class="pos-card"><div class="pos-dot2" id="dot-CTY"></div><div class="pos-card-info"><div class="pos-card-call" id="call-CTY">CTY</div><div class="pos-card-sub" id="sub-CTY">City Â· Hors ligne</div></div><div class="pos-card-freq">118.800</div></div>
          <div class="pos-card"><div class="pos-dot2" id="dot-WLD"></div><div class="pos-card-info"><div class="pos-card-call" id="call-WLD">WLD</div><div class="pos-card-sub" id="sub-WLD">World Â· Hors ligne</div></div><div class="pos-card-freq">123.500</div></div>
          <div class="pos-card"><div class="pos-dot2" id="dot-ARL"></div><div class="pos-card-info"><div class="pos-card-call" id="call-ARL">ARL</div><div class="pos-card-sub" id="sub-ARL">Aerial Â· Hors ligne</div></div><div class="pos-card-freq">124.615</div></div>
        </div>
      </div>
      <div class="card glob-panel">
        <div class="card-head" style="display:flex;align-items:center;">
          Utilisateurs en ligne
          <span class="glob-count" id="globCount">0</span>
        </div>
        <div class="glob-scroll" id="globList"><div class="no-glob">Aucun utilisateur en ligne</div></div>
      </div>
      <div class="card chat-panel">
        <div class="card-head">Chat frÃ©quence</div>
        <div class="chat-msgs" id="chatMsgs"><div class="msg sys-line"><span class="msg-text">Connectez-vous pour accÃ©der au chat.</span></div></div>
        <div class="chat-input-row">
          <input class="chat-in" id="chatIn" placeholder="Message sur la frÃ©quence..." maxlength="200" onkeydown="if(event.key==='Enter')sendChat()" disabled>
          <button class="chat-send" id="chatSend" onclick="sendChat()" disabled>ENVOYER</button>
        </div>
      </div>
    </div>
  </div>

  <div class="statusbar">
    <div class="si"><div class="sdot" id="sdMic"></div><span id="sMic">Micro: â€”</span></div>
    <div class="si"><div class="sdot" id="sdConn"></div><span id="sConn">DÃ©connectÃ©</span></div>
    <div class="si" style="margin-left:auto;opacity:.35;font-size:10px;"><span id="sUID"></span></div>
  </div>
</div>

<!-- Context Menu -->
<div class="ctx-menu" id="ctxMenu">
  <div class="ctx-hdr" id="ctxTitle">Options</div>
  <div class="ctx-item danger" onclick="doForceACT()"><span class="ctx-ico">âš </span>Force ACT</div>
  <div class="ctx-sep"></div>
  <div class="xfer-wrap">
    <div class="ctx-item xfer"><span class="ctx-ico">â†—</span>TransfÃ©rer vers...<span class="ctx-ico-arrow">â–¶</span></div>
    <div class="ctx-sub" id="ctxSub"></div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FIREBASE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
firebase.initializeApp({
  apiKey:"AIzaSyDxDzLbCnqYYVknoyHMzbE0gB_SRVLpgiw",
  authDomain:"kyky-c3471.firebaseapp.com",
  databaseURL:"https://kyky-c3471-default-rtdb.europe-west1.firebasedatabase.app",
  projectId:"kyky-c3471",
  storageBucket:"kyky-c3471.firebasestorage.app",
  messagingSenderId:"658643330578",
  appId:"1:658643330578:web:758dc26d5504a503e39acb"
});
const db = firebase.database();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   IDENTITY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let uid = sessionStorage.getItem('atc_uid');
if (!uid) { uid = 'ATC_' + Math.random().toString(36).substr(2,8).toUpperCase(); sessionStorage.setItem('atc_uid', uid); }
document.getElementById('uidLabel').textContent = uid;
document.getElementById('sUID').textContent = 'UID: ' + uid;

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONSTANTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const CTRL_DEFS = [
  {pos:'CTY', freq:'118.800', label:'City'},
  {pos:'WLD', freq:'123.500', label:'World'},
  {pos:'ARL', freq:'124.615', label:'Aerial'},
];
const FORCE_ACT_MSG = {
  CTY: 'GOOD DAY PLEASE CONTACT CITY ON 118.800',
  WLD: 'GOOD DAY PLEASE CONTACT WORLD ON 123.500',
  ARL: 'GOOD DAY PLEASE CONTACT AERIAL ON 124.615',
};
const STUN = { iceServers: [{urls:'stun:stun.l.google.com:19302'},{urls:'stun:stun1.l.google.com:19302'}] };

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let selPos = null, selFreq = null, callsign = '';
let connected = false;
let localStream = null;
let pttActive = false, pttLocked = false;
let inDevId = null, outDevId = null;

// peerId â†’ RTCPeerConnection
const peers = {};
// peerId â†’ <audio> element
const audEls = {};
// peerId â†’ [ICE candidates waiting for remote desc]
const candQueues = {};

let activeRefs = [];
let connectedMembers = {};
let onlineControllers = {};

// Context menu target
let ctxTargetUid = null, ctxTargetName = null;

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DEVICES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function loadDevices() {
  try {
    const tmp = await navigator.mediaDevices.getUserMedia({audio:true});
    tmp.getTracks().forEach(t => t.stop());
    const devs = await navigator.mediaDevices.enumerateDevices();
    const ins  = devs.filter(d => d.kind === 'audioinput');
    const outs = devs.filter(d => d.kind === 'audiooutput');
    const iS = document.getElementById('inDev');
    const oS = document.getElementById('outDev');
    iS.innerHTML = ins.map((d,i) => `<option value="${d.deviceId}">${d.label||'Micro '+(i+1)}</option>`).join('');
    oS.innerHTML = outs.map((d,i) => `<option value="${d.deviceId}">${d.label||'Sortie '+(i+1)}</option>`).join('');
    inDevId  = ins[0]?.deviceId;
    outDevId = outs[0]?.deviceId;
    iS.onchange = () => { inDevId  = iS.value; };
    oS.onchange = () => { outDevId = oS.value; };
    document.getElementById('sdMic').classList.add('ok');
    document.getElementById('sMic').textContent = 'Micro: PrÃªt';
  } catch(e) {
    document.getElementById('sMic').textContent = 'Micro: AccÃ¨s refusÃ©';
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   POSITION SELECTION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function selectPos(btn) {
  if (connected) return;
  document.querySelectorAll('.pos-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  selPos = btn.dataset.pos;
  selFreq = btn.dataset.freq;
  document.getElementById('lcdFreq').textContent = selFreq;
  document.getElementById('lcdFreq').classList.remove('off');
  document.getElementById('lcdPos').textContent = 'â€” ' + selPos + ' â€”';
  const ci = document.getElementById('callsignInput');
  if (!ci.value) ci.value = 'KYKY_' + selPos;
  document.getElementById('connBtn').disabled = false;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONNECT / DISCONNECT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function toggleConn() {
  if (connected) await doDisconnect(); else await doConnect();
}

async function doConnect() {
  callsign = (document.getElementById('callsignInput').value.trim().toUpperCase()) || ('KYKY_' + selPos);
  inDevId  = document.getElementById('inDev').value;
  outDevId = document.getElementById('outDev').value;

  try {
    localStream = await navigator.mediaDevices.getUserMedia({
      audio: { deviceId: inDevId ? {exact:inDevId} : undefined, echoCancellation:true, noiseSuppression:true },
      video: false
    });
    // Start muted â€” only open on PTT
    localStream.getAudioTracks().forEach(t => { t.enabled = false; });
  } catch(e) {
    alert('Microphone inaccessible:\n' + e.message);
    return;
  }

  connected = true;
  setConnectedUI(true);
  const fk = fKey(selFreq);

  // Controller presence
  const ctrlRef = db.ref('controllers/' + selPos);
  await ctrlRef.set({ uid, callsign, frequency: selFreq, online: true, ts: Date.now() });
  ctrlRef.onDisconnect().remove();
  activeRefs.push(ctrlRef);

  // Session member
  const memRef = db.ref(`sessions/${fk}/members/${uid}`);
  await memRef.set({ name: callsign, position: selPos, type: 'controller', ts: Date.now() });
  memRef.onDisconnect().remove();
  activeRefs.push(memRef);

  // Clear stale signaling
  await db.ref(`signaling/${fk}/${uid}`).remove();

  // Listen for signaling messages addressed to me
  const sigRef = db.ref(`signaling/${fk}/${uid}`);
  sigRef.on('child_added', async snap => {
    const pid = snap.key;
    const data = snap.val();
    if (!data) return;
    if (data.offer  && !peers[pid]) await handleOffer(pid, data.offer, fk);
    if (data.answer &&  peers[pid]) await handleAnswer(pid, data.answer);
  });
  activeRefs.push(sigRef);

  // Members list â€” connect to existing + watch for newcomers
  const memListRef = db.ref(`sessions/${fk}/members`);
  memListRef.on('value', snap => {
    connectedMembers = {};
    snap.forEach(s => { if (s.key !== uid) connectedMembers[s.key] = s.val(); });
    buildUsrList();
  });
  memListRef.on('child_added', async snap => {
    const pid = snap.key;
    if (pid === uid || peers[pid]) return;
    if (uid > pid) await initiateConn(pid, fk);  // higher UID initiates
  });
  memListRef.on('child_removed', snap => killPeer(snap.key));
  activeRefs.push(memListRef);

  // Transmitting state
  const txRef = db.ref(`sessions/${fk}/transmitting`);
  txRef.on('value', snap => handleTX(snap.val()));
  activeRefs.push(txRef);

  // Chat
  const chatRef = db.ref(`sessions/${fk}/chat`).limitToLast(100);
  chatRef.on('child_added', snap => appendMsg(snap.val()));
  activeRefs.push(chatRef);

  // Commands sent TO me by other controllers
  const cmdRef = db.ref(`commands/${uid}`);
  cmdRef.on('child_added', async snap => {
    const cmd = snap.val(); if (!cmd) return;
    await snap.ref.remove();
    handleCommand(cmd);
  });
  activeRefs.push(cmdRef);

  document.getElementById('sConn').textContent = callsign + ' @ ' + selFreq;
  document.getElementById('sdConn').classList.add('ok');
  document.getElementById('pttBtn').disabled = false;
  document.getElementById('chatIn').disabled = false;
  document.getElementById('chatSend').disabled = false;
  addSys('ConnectÃ© sur ' + selPos + ' (' + selFreq + ' MHz)');
}

async function doDisconnect() {
  stopPTT();
  const fk = fKey(selFreq);

  // Release TX lock if we hold it
  const txSnap = await db.ref(`sessions/${fk}/transmitting`).get();
  if (txSnap.val()?.uid === uid) await db.ref(`sessions/${fk}/transmitting`).remove();

  await db.ref(`sessions/${fk}/members/${uid}`).remove();
  await db.ref('controllers/' + selPos).remove();
  await db.ref(`signaling/${fk}/${uid}`).remove();

  // Detach all listeners
  activeRefs.forEach(r => r.off && r.off());
  activeRefs = [];

  // Close all peer connections
  Object.keys(peers).forEach(killPeer);

  // Stop microphone
  localStream?.getTracks().forEach(t => t.stop());
  localStream = null;

  connected = false;
  connectedMembers = {};
  setConnectedUI(false);
  document.getElementById('sConn').textContent = 'DÃ©connectÃ©';
  document.getElementById('sdConn').classList.remove('ok');
  document.getElementById('pttBtn').disabled = true;
  document.getElementById('chatIn').disabled = true;
  document.getElementById('chatSend').disabled = true;
  buildUsrList();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   WebRTC
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function initiateConn(pid, fk) {
  const pc = makePeer(pid, fk);
  localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  await db.ref(`signaling/${fk}/${pid}/${uid}`).set({ offer: { type: offer.type, sdp: offer.sdp } });
}

async function handleOffer(pid, offer, fk) {
  const pc = makePeer(pid, fk);
  localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
  await pc.setRemoteDescription(new RTCSessionDescription(offer));
  // Flush queued ICE candidates
  for (const c of (candQueues[pid] || [])) {
    try { await pc.addIceCandidate(new RTCIceCandidate(c)); } catch(e) {}
  }
  delete candQueues[pid];
  const answer = await pc.createAnswer();
  await pc.setLocalDescription(answer);
  await db.ref(`signaling/${fk}/${pid}/${uid}`).update({ answer: { type: answer.type, sdp: answer.sdp } });
}

async function handleAnswer(pid, answer) {
  const pc = peers[pid];
  if (!pc || pc.signalingState !== 'have-local-offer') return;
  await pc.setRemoteDescription(new RTCSessionDescription(answer));
}

function makePeer(pid, fk) {
  const pc = new RTCPeerConnection(STUN);
  peers[pid] = pc;

  pc.onicecandidate = e => {
    if (e.candidate) {
      db.ref(`signaling/${fk}/${pid}/${uid}/candidates`).push(e.candidate.toJSON());
    }
  };

  pc.ontrack = e => {
    let a = audEls[pid];
    if (!a) {
      a = document.createElement('audio');
      a.autoplay = true;
      audEls[pid] = a;
      if (outDevId && a.setSinkId) a.setSinkId(outDevId).catch(() => {});
    }
    if (a.srcObject !== e.streams[0]) {
      a.srcObject = e.streams[0];
    }
  };

  pc.oniceconnectionstatechange = () => {
    if (['disconnected','failed','closed'].includes(pc.iceConnectionState)) killPeer(pid);
  };

  // Listen for ICE candidates addressed to me from this peer
  const cRef = db.ref(`signaling/${fk}/${uid}/${pid}/candidates`);
  cRef.on('child_added', async snap => {
    const c = snap.val();
    if (peers[pid]?.remoteDescription) {
      try { await peers[pid].addIceCandidate(new RTCIceCandidate(c)); } catch(e) {}
    } else {
      if (!candQueues[pid]) candQueues[pid] = [];
      candQueues[pid].push(c);
    }
  });
  activeRefs.push(cRef);

  return pc;
}

function killPeer(pid) {
  peers[pid]?.close();
  delete peers[pid];
  if (audEls[pid]) {
    audEls[pid].pause();
    audEls[pid].srcObject = null;
    delete audEls[pid];
  }
  delete candQueues[pid];
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PTT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function startPTT() {
  if (!connected || pttLocked || pttActive || !localStream) return;
  pttActive = true;
  localStream.getAudioTracks().forEach(t => { t.enabled = true; });
  document.getElementById('pttBtn').classList.add('tx');
  document.getElementById('ledVous').classList.add('on');
  db.ref(`sessions/${fKey(selFreq)}/transmitting`).set({ uid, name: callsign, pos: selPos, ts: Date.now() });
}

function stopPTT() {
  if (!pttActive) return;
  pttActive = false;
  localStream?.getAudioTracks().forEach(t => { t.enabled = false; });
  document.getElementById('pttBtn').classList.remove('tx');
  document.getElementById('ledVous').classList.remove('on');
  if (connected && selFreq) {
    const fk = fKey(selFreq);
    db.ref(`sessions/${fk}/transmitting`).get().then(s => {
      if (s.val()?.uid === uid) db.ref(`sessions/${fk}/transmitting`).remove();
    });
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATIC AUDIO (reception)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const staticAudio = new Audio('static.mp3');
staticAudio.loop = true;
staticAudio.volume = 0.07;

function startStatic() {
  if (staticAudio.paused) staticAudio.play().catch(() => {});
}
function stopStatic() {
  if (!staticAudio.paused) { staticAudio.pause(); staticAudio.currentTime = 0; }
}

function handleTX(data) {
  const lE = document.getElementById('ledExt');
  const lV = document.getElementById('ledVous');
  const pb = document.getElementById('pttBtn');
  const bn = document.getElementById('txBanner');
  const wh = document.getElementById('extWho');

  if (data && data.uid !== uid) {
    // Someone else is transmitting
    startStatic();
    lE.classList.add('on');
    wh.textContent = data.name || '?';
    pttLocked = true;
    pb.classList.add('locked');
    bn.textContent = 'â— ' + (data.name || '?') + ' EN Ã‰MISSION';
    bn.classList.add('show');
    if (pttActive) stopPTT();
  } else if (data && data.uid === uid) {
    // We are transmitting
    stopStatic();
    lV.classList.add('on');
    lE.classList.remove('on');
    wh.textContent = '';
    bn.classList.remove('show');
  } else {
    // Channel clear
    stopStatic();
    lE.classList.remove('on');
    lV.classList.remove('on');
    wh.textContent = '';
    pttLocked = false;
    pb.classList.remove('locked');
    bn.classList.remove('show');
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CHAT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function sendChat() {
  const inp = document.getElementById('chatIn');
  const txt = inp.value.trim();
  if (!txt || !connected) return;
  db.ref(`sessions/${fKey(selFreq)}/chat`).push({
    uid, name: callsign, text: txt, type: 'controller', ts: Date.now()
  });
  inp.value = '';
}

function appendMsg(msg) {
  if (!msg) return;
  const box = document.getElementById('chatMsgs');
  const div = document.createElement('div');
  div.className = 'msg';
  const ts = fmtTime(msg.ts);
  const isMe = msg.uid === uid;

  if (msg.msgType === 'sys-red' || msg.msgType === 'sys-green') {
    div.innerHTML = `<span class="msg-time">${ts}</span>`
      + `<span class="msg-name ${msg.msgType==='sys-red'?'n-user':'n-ctrl'}">${esc(msg.name||'SYS')}</span>`
      + `<span class="msg-text ${msg.msgType==='sys-red'?'t-red':'t-green'}">${esc(msg.text)}</span>`;
  } else {
    const nc = isMe ? 'n-me' : (msg.type === 'controller' ? 'n-ctrl' : 'n-user');
    div.innerHTML = `<span class="msg-time">${ts}</span>`
      + `<span class="msg-name ${nc}">${esc(msg.name||'?')}</span>`
      + `<span class="msg-text">${esc(msg.text)}</span>`;
  }
  box.appendChild(div);
  box.scrollTop = box.scrollHeight;
}

function addSys(txt) {
  const box = document.getElementById('chatMsgs');
  const div = document.createElement('div');
  div.className = 'msg sys-line';
  div.innerHTML = `<span class="msg-text">${esc(txt)}</span>`;
  box.appendChild(div);
  box.scrollTop = box.scrollHeight;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   COMMANDS (received by me)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function handleCommand(cmd) {
  const box = document.getElementById('chatMsgs');
  const div = document.createElement('div');
  div.className = 'msg';
  const ts = fmtTime(Date.now());
  if (cmd.type === 'forceact') {
    playSound('forceact.mp3', 1.0, 'alarm');
    div.innerHTML = `<span class="msg-time">${ts}</span><span class="msg-name n-user">âš  CONTRÃ”LE</span><span class="msg-text t-red">${esc(cmd.message)}</span>`;
  } else if (cmd.type === 'transfer') {
    playSound('notification.mp3', 0.7, 'calm');
    div.innerHTML = `<span class="msg-time">${ts}</span><span class="msg-name n-ctrl">â†— TRANSFERT</span><span class="msg-text t-green">${esc(cmd.message)}</span>`;
  }
  box.appendChild(div);
  box.scrollTop = box.scrollHeight;
}

function playSound(file, vol, type) {
  const a = new Audio(file);
  a.volume = vol;
  a.play().catch(() => {
    try {
      const ctx = new AudioContext();
      if (type === 'alarm') {
        [0, 0.28, 0.56].forEach(t => {
          const o = ctx.createOscillator(), g = ctx.createGain();
          o.connect(g); g.connect(ctx.destination);
          o.frequency.value = 880; g.gain.value = 0.35;
          o.start(ctx.currentTime + t); o.stop(ctx.currentTime + t + 0.18);
        });
        setTimeout(() => ctx.close(), 1500);
      } else {
        const now = ctx.currentTime;
        [[523, 0], [659, 0.18]].forEach(([freq, delay]) => {
          const o = ctx.createOscillator(), g = ctx.createGain();
          o.type = 'sine'; o.frequency.value = freq;
          g.gain.setValueAtTime(0, now + delay);
          g.gain.linearRampToValueAtTime(0.22, now + delay + 0.04);
          g.gain.exponentialRampToValueAtTime(0.001, now + delay + 0.6);
          o.connect(g); g.connect(ctx.destination);
          o.start(now + delay); o.stop(now + delay + 0.7);
        });
        setTimeout(() => ctx.close(), 1200);
      }
    } catch(e) {}
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONTEXT MENU
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
document.addEventListener('click', e => {
  const menu = document.getElementById('ctxMenu');
  if (menu.style.display === 'block' && !menu.contains(e.target)) closeCtx();
});

function openCtx(e, pid, name) {
  ctxTargetUid  = pid;
  ctxTargetName = name;
  document.getElementById('ctxTitle').textContent = 'ğŸ‘¤ ' + name;

  // Build transfer submenu using data attributes (avoids esc() breaking onclick)
  const sub = document.getElementById('ctxSub');
  sub.innerHTML = '';
  sub.classList.remove('open');

  const others = CTRL_DEFS.filter(d => d.pos !== selPos && onlineControllers[d.pos]);
  if (!others.length) {
    const el = document.createElement('div');
    el.className = 'ctx-sub-item off';
    el.textContent = 'Aucune autre position en ligne';
    sub.appendChild(el);
  } else {
    others.forEach(d => {
      const c = onlineControllers[d.pos];
      const el = document.createElement('div');
      el.className = 'ctx-sub-item';
      el.innerHTML = `<div class="ctx-sub-dot"></div><div class="ctx-sub-info"><div class="ctx-sub-call">${esc(c.callsign)}</div><div class="ctx-sub-freq">${d.freq} MHz</div></div>`;
      el.dataset.pos      = d.pos;
      el.dataset.freq     = d.freq;
      el.dataset.callsign = c.callsign;
      el.addEventListener('click', () => doTransfer(el.dataset.pos, el.dataset.freq, el.dataset.callsign));
      sub.appendChild(el);
    });
  }

  const menu = document.getElementById('ctxMenu');
  menu.style.display = 'block';
  const x = Math.min(e.clientX, window.innerWidth  - 215);
  const y = Math.min(e.clientY, window.innerHeight - 160);
  menu.style.left = x + 'px';
  menu.style.top  = y + 'px';
  e.stopPropagation();
}
function closeCtx()  { document.getElementById('ctxMenu').style.display = 'none'; }

function doForceACT() {
  if (!ctxTargetUid) return;
  const pos = selPos || 'CTY';
  const msg = FORCE_ACT_MSG[pos] || 'GOOD DAY PLEASE CONTACT CONTROL';
  db.ref(`commands/${ctxTargetUid}`).push({
    type:'forceact', from:uid, fromPos:pos, fromCallsign:callsign||uid,
    message:msg, ts:Date.now()
  });
  // Show red message in OUR chat too so we see what we sent
  const box = document.getElementById('chatMsgs');
  const div = document.createElement('div');
  div.className = 'msg';
  div.innerHTML = `<span class="msg-time">${fmtTime(Date.now())}</span>`
    + `<span class="msg-name n-user">âš  FORCE ACT â†’ ${esc(ctxTargetName)}</span>`
    + `<span class="msg-text t-red">${esc(msg)}</span>`;
  box.appendChild(div); box.scrollTop = box.scrollHeight;
  closeCtx();
}

function doTransfer(toPos, toFreq, toCallsign) {
  if (!ctxTargetUid) return;
  const msg = `Please switch to ${toFreq} (${toCallsign})`;
  db.ref(`commands/${ctxTargetUid}`).push({
    type:'transfer', from:uid, fromPos:selPos, fromCallsign:callsign,
    toPos, toFreq, toCallsign, message:msg, ts:Date.now()
  });
  // Confirmation in our chat
  const box = document.getElementById('chatMsgs');
  const div = document.createElement('div');
  div.className = 'msg';
  div.innerHTML = `<span class="msg-time">${fmtTime(Date.now())}</span>`
    + `<span class="msg-name n-ctrl">â†— TRANSFER â†’ ${esc(ctxTargetName)}</span>`
    + `<span class="msg-text t-green">${esc(msg)}</span>`;
  box.appendChild(div); box.scrollTop = box.scrollHeight;
  closeCtx();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   USERS ON FREQUENCY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function buildUsrList() {
  const list = document.getElementById('usrList');
  if (!connected) { list.innerHTML = '<div class="no-users">Non connectÃ©</div>'; return; }
  const entries = Object.entries(connectedMembers);
  if (!entries.length) { list.innerHTML = '<div class="no-users">Aucun utilisateur sur cette frÃ©quence</div>'; return; }
  list.innerHTML = entries.map(([pid, m]) =>
    `<div class="usr-row" onclick="openCtx(event,'${pid}','${m.name||pid}')">
      <div class="usr-dot"></div>
      <div>
        <div class="usr-name">${esc(m.name || pid)}</div>
        <div class="usr-hint">${m.type === 'controller' ? 'ContrÃ´leur' : 'Joueur'} Â· cliquer</div>
      </div>
    </div>`
  ).join('');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ONLINE CONTROLLERS PANEL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function updateOnlinePanel(data) {
  onlineControllers = data || {};
  CTRL_DEFS.forEach(d => {
    const c   = onlineControllers[d.pos];
    const on  = !!c;
    const dot  = document.getElementById('dot-'  + d.pos);
    const call = document.getElementById('call-' + d.pos);
    const sub  = document.getElementById('sub-'  + d.pos);
    if (dot)  dot.classList.toggle('on', on);
    if (call) { call.textContent = on ? c.callsign : d.pos; call.className = 'pos-card-call' + (on ? ' on' : ''); }
    if (sub)  sub.textContent = d.label + ' Â· ' + (on ? 'En ligne' : 'Hors ligne');
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GLOBAL ONLINE USERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
// All known frequencies to watch
const ALL_FREQS = [
  {freq:'118.800', pos:'CTY', label:'CTY'},
  {freq:'123.500', pos:'WLD', label:'WLD'},
  {freq:'124.615', pos:'ARL', label:'ARL'},
  {freq:'122.800', pos:'UNICOM', label:'UNICOM'},
];
let globalUsers = {}; // uid â†’ {name, freq, pos, type}

function startGlobalWatch() {
  ALL_FREQS.forEach(f => {
    const ref = db.ref(`sessions/${fKey(f.freq)}/members`);
    ref.on('value', snap => {
      // Remove old entries for this freq
      Object.keys(globalUsers).forEach(id => {
        if (globalUsers[id].freq === f.freq) delete globalUsers[id];
      });
      snap.forEach(s => {
        if (s.key !== uid) { // exclude ourselves
          globalUsers[s.key] = { ...s.val(), freq: f.freq, pos: f.pos };
        }
      });
      buildGlobList();
    });
  });
}

function buildGlobList() {
  const list  = document.getElementById('globList');
  const count = document.getElementById('globCount');
  const entries = Object.entries(globalUsers);
  count.textContent = entries.length;
  if (!entries.length) {
    list.innerHTML = '<div class="no-glob">Aucun utilisateur en ligne</div>';
    return;
  }
  list.innerHTML = entries.map(([pid, m]) => {
    const isUnicom = m.pos === 'UNICOM';
    return `<div class="glob-row" onclick="openCtx(event,'${pid}','${m.name||pid}')">
      <div class="glob-dot"></div>
      <div class="glob-info">
        <div class="glob-name">${esc(m.name || pid)}</div>
        <div class="glob-freq">${m.freq} MHz</div>
      </div>
      <div class="glob-badge${isUnicom?' unicom':''}">${m.pos}</div>
    </div>`;
  }).join('');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   UI HELPERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function setConnectedUI(on) {
  const btn = document.getElementById('connBtn');
  if (on) {
    btn.textContent = 'Se DÃ©connecter'; btn.classList.add('disc');
    ['callsignInput','inDev','outDev'].forEach(id => document.getElementById(id).disabled = true);
    document.querySelectorAll('.pos-btn').forEach(b => b.style.pointerEvents = 'none');
  } else {
    btn.textContent = 'Se Connecter'; btn.classList.remove('disc');
    ['callsignInput','inDev','outDev'].forEach(id => document.getElementById(id).disabled = false);
    document.querySelectorAll('.pos-btn').forEach(b => b.style.pointerEvents = '');
    document.getElementById('lcdFreq').className = 'lcd-freq off';
    document.getElementById('lcdPos').textContent = 'â€” NON CONNECTÃ‰ â€”';
    document.getElementById('ledExt').classList.remove('on');
    document.getElementById('ledVous').classList.remove('on');
    document.getElementById('txBanner').classList.remove('show');
    document.getElementById('extWho').textContent = '';
  }
}

function fKey(f)    { return f.replace('.', '_'); }
function fmtTime(ts){ if (!ts) return '--:--'; const t=new Date(ts); return t.getHours().toString().padStart(2,'0')+':'+t.getMinutes().toString().padStart(2,'0'); }
function esc(s)     { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   KEYBOARD PTT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
document.addEventListener('keydown', e => {
  if (e.code === 'Space' && !e.repeat && connected && document.activeElement.tagName !== 'INPUT') {
    e.preventDefault(); startPTT();
  }
});
document.addEventListener('keyup', e => { if (e.code === 'Space') stopPTT(); });

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   UNLOAD CLEANUP
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
window.addEventListener('beforeunload', () => {
  if (!connected) return;
  const fk = fKey(selFreq);
  db.ref(`sessions/${fk}/members/${uid}`).remove();
  db.ref('controllers/' + selPos).remove();
  db.ref(`signaling/${fk}/${uid}`).remove();
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INIT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
loadDevices();
startGlobalWatch();
db.ref('controllers').on('value', snap => updateOnlinePanel(snap.val()));
</script>
</body>
</html>
