<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>KYKY RADIO — CONTRÔLEUR ATC</title>
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Rajdhani:wght@500;600;700&family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #07080a;
  --panel: #0f1113;
  --panel-b: #13161a;
  --panel-c: #1a1e24;
  --border: #232830;
  --border-hi: #363d48;
  --amber: #ffaa00;
  --amber-lo: #3d2800;
  --amber-mid: #8a5a00;
  --green: #00e647;
  --green-lo: #002d10;
  --red: #ff3333;
  --red-lo: #2d0808;
  --txt: #b8bec8;
  --txt-lo: #4a5060;
  --txt-mid: #7a8290;
  --lcd: #080f08;
}
*{margin:0;padding:0;box-sizing:border-box;}
html,body{height:100%;background:var(--bg);color:var(--txt);font-family:'Rajdhani',sans-serif;}

/* Scanlines overlay for CRT feel */
body::before{
  content:'';position:fixed;inset:0;pointer-events:none;z-index:9999;
  background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,0.04) 2px,rgba(0,0,0,0.04) 4px);
}

.layout{display:flex;flex-direction:column;height:100%;}

/* ── TOPBAR ── */
.topbar{
  background:#090b0d;border-bottom:1px solid var(--border);
  padding:0 20px;height:44px;display:flex;align-items:center;gap:16px;flex-shrink:0;
}
.logo{font-family:'Orbitron',monospace;font-size:15px;color:var(--amber);letter-spacing:4px;font-weight:700;}
.sep{width:1px;height:20px;background:var(--border);}
.topbar-sub{font-size:11px;color:var(--txt-lo);letter-spacing:3px;text-transform:uppercase;}
.topbar-right{margin-left:auto;font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--txt-lo);}

/* ── MAIN AREA ── */
.main{flex:1;display:flex;gap:16px;padding:16px;overflow:auto;align-items:flex-start;}

/* ── PANEL BASE ── */
.card{background:var(--panel);border:1px solid var(--border);border-radius:5px;overflow:hidden;}
.card-head{
  background:#0b0d0f;border-bottom:1px solid var(--border);
  padding:7px 14px;font-size:10px;font-weight:700;
  letter-spacing:3px;color:var(--txt-lo);text-transform:uppercase;
}

/* ── CONNECTION MANAGER ── */
.conn-panel{width:250px;flex-shrink:0;}

.pos-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:1px;background:var(--border);border-bottom:1px solid var(--border);}
.pos-btn{
  background:var(--panel);border:none;padding:13px 6px;cursor:pointer;
  text-align:center;transition:background .15s;position:relative;
}
.pos-btn:hover{background:var(--panel-c);}
.pos-btn.active{background:#0e1a0c;}
.pos-btn.active::after{content:'';position:absolute;bottom:0;left:0;right:0;height:2px;background:var(--green);}
.pos-code{font-family:'Orbitron',monospace;font-size:15px;font-weight:700;color:var(--txt-lo);}
.pos-btn.active .pos-code{color:var(--green);}
.pos-name{font-size:9px;color:var(--txt-lo);letter-spacing:1px;margin-top:3px;text-transform:uppercase;}
.pos-hz{font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--amber-lo);margin-top:4px;}
.pos-btn.active .pos-hz{color:var(--amber);}

.fg{padding:12px 14px;border-bottom:1px solid var(--border);}
.fl{font-size:10px;letter-spacing:2px;color:var(--txt-lo);text-transform:uppercase;margin-bottom:6px;font-weight:700;}
input.fi,select.fi{
  width:100%;background:#08090b;border:1px solid var(--border);border-radius:3px;
  padding:7px 10px;color:var(--amber);font-family:'Orbitron',monospace;
  font-size:12px;letter-spacing:2px;outline:none;text-transform:uppercase;
  transition:border-color .15s;
}
input.fi::placeholder{color:var(--amber-lo);}
input.fi:focus{border-color:var(--amber-lo);}
select.fi{color:var(--txt);font-family:'Rajdhani',sans-serif;font-size:13px;letter-spacing:0;cursor:pointer;}

.conn-btn{
  display:block;width:calc(100% - 24px);margin:12px;padding:11px;
  background:#0a160a;border:1px solid #1d3d1d;border-radius:3px;
  color:var(--green);font-family:'Orbitron',monospace;font-size:11px;
  letter-spacing:3px;cursor:pointer;transition:all .15s;text-transform:uppercase;
}
.conn-btn:hover:not(:disabled){background:#102010;border-color:var(--green);}
.conn-btn.disc{background:#160a0a;border-color:#3d1d1d;color:var(--red);}
.conn-btn:disabled{opacity:.4;cursor:not-allowed;}

/* ── VHF BOX ── */
.vhf-box{
  width:300px;flex-shrink:0;
  background:var(--panel-b);border:2px solid var(--border-hi);
  border-radius:7px;
  box-shadow:0 8px 32px rgba(0,0,0,.6),inset 0 1px 0 rgba(255,255,255,.04);
}
.vhf-top{
  background:#090b0d;border-bottom:1px solid var(--border);
  padding:6px 12px;display:flex;justify-content:space-between;align-items:center;
}
.vhf-brand{font-family:'Orbitron',monospace;font-size:8px;letter-spacing:3px;color:var(--txt-lo);}

/* LCD Display */
.lcd-wrap{margin:12px;background:var(--lcd);border-radius:3px;
  border:1px solid #0a180a;box-shadow:inset 0 2px 12px rgba(0,0,0,.7);padding:10px 14px;}
.lcd-top{display:flex;align-items:baseline;gap:6px;justify-content:center;}
.lcd-freq{
  font-family:'Share Tech Mono',monospace;font-size:36px;
  color:var(--amber);letter-spacing:3px;
  text-shadow:0 0 24px rgba(255,170,0,.5),0 0 48px rgba(255,170,0,.2);
  transition:all .3s;
}
.lcd-freq.off{color:var(--amber-lo);text-shadow:none;}
.lcd-unit{font-family:'Rajdhani',sans-serif;font-size:11px;color:var(--amber-mid);align-self:flex-end;padding-bottom:4px;}
.lcd-pos{
  text-align:center;font-family:'Orbitron',monospace;
  font-size:9px;color:var(--txt-lo);letter-spacing:3px;margin-top:4px;
}

/* Indicators */
.indics{display:flex;gap:8px;margin:0 12px 12px;}
.indic{
  flex:1;background:#0a0c0e;border:1px solid var(--border);border-radius:3px;
  padding:8px 8px;display:flex;align-items:center;gap:8px;
}
.led{width:10px;height:10px;border-radius:50%;flex-shrink:0;transition:all .08s;}
.led-r{background:var(--red-lo);}
.led-g{background:var(--green-lo);}
.led-r.on{background:var(--red);box-shadow:0 0 10px var(--red),0 0 20px rgba(255,51,51,.4);}
.led-g.on{background:var(--green);box-shadow:0 0 10px var(--green),0 0 20px rgba(0,230,71,.4);}
.led-lbl{font-family:'Orbitron',monospace;font-size:9px;letter-spacing:1px;color:var(--txt-lo);font-weight:700;}
.led-who{font-size:9px;color:var(--txt-lo);margin-left:auto;font-family:'Share Tech Mono',monospace;max-width:80px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}

/* TX Banner */
.tx-banner{
  display:none;margin:0 12px 10px;padding:6px 10px;
  background:rgba(255,51,51,.08);border:1px solid rgba(255,51,51,.25);
  border-radius:3px;font-family:'Orbitron',monospace;
  font-size:9px;color:var(--red);letter-spacing:2px;text-align:center;
  animation:blink-tx 1.2s step-start infinite;
}
.tx-banner.show{display:block;}
@keyframes blink-tx{50%{opacity:.4;}}

/* PTT */
.ptt-wrap{margin:0 12px 14px;}
.ptt-btn{
  width:100%;padding:15px;background:#140e0e;border:2px solid #2e1818;
  border-radius:4px;color:#884444;font-family:'Orbitron',monospace;
  font-size:11px;letter-spacing:3px;cursor:pointer;transition:all .05s;
  user-select:none;position:relative;text-transform:uppercase;
}
.ptt-btn:not(.locked):not(:disabled):hover{border-color:#553333;color:#aa5555;}
.ptt-btn.tx{
  background:#1c0808;border-color:var(--red);color:var(--red);
  box-shadow:0 0 24px rgba(255,51,51,.2);
}
.ptt-btn.locked,.ptt-btn:disabled{opacity:.45;cursor:not-allowed;}
.ptt-hint{text-align:center;font-size:10px;color:var(--txt-lo);margin-top:5px;letter-spacing:2px;}

/* ── ONLINE PANEL ── */
.online-panel{flex:1;min-width:240px;}
.pos-row{
  padding:10px 14px;display:flex;align-items:center;gap:10px;
  border-bottom:1px solid var(--border);
}
.pos-row:last-child{border-bottom:none;}
.dot{width:7px;height:7px;border-radius:50%;background:var(--green-lo);flex-shrink:0;transition:all .3s;}
.dot.on{background:var(--green);box-shadow:0 0 7px var(--green);}
.row-info{flex:1;}
.row-call{font-family:'Orbitron',monospace;font-size:12px;color:var(--txt);font-weight:700;}
.row-detail{font-size:11px;color:var(--txt-lo);margin-top:2px;}
.freq-badge{
  font-family:'Share Tech Mono',monospace;font-size:11px;
  background:var(--lcd);border:1px solid var(--border);
  padding:3px 8px;border-radius:2px;color:var(--amber);
}
.no-ctrl{padding:24px;text-align:center;color:var(--txt-lo);font-size:11px;letter-spacing:2px;}

/* ── STATUS BAR ── */
.statusbar{
  background:#06070a;border-top:1px solid var(--border);
  padding:5px 20px;display:flex;gap:20px;flex-shrink:0;
}
.si{display:flex;align-items:center;gap:7px;font-size:11px;color:var(--txt-lo);letter-spacing:1px;}
.sdot{width:5px;height:5px;border-radius:50%;background:#1a1e24;transition:background .3s;}
.sdot.ok{background:var(--green);}
</style>
</head>
<body>
<div class="layout">

  <!-- TOPBAR -->
  <div class="topbar">
    <span class="logo">KYKY</span>
    <div class="sep"></div>
    <span class="topbar-sub">Station de Contrôle ATC</span>
    <div class="topbar-right" id="uidLabel"></div>
  </div>

  <!-- MAIN -->
  <div class="main">

    <!-- Connection Manager -->
    <div class="card conn-panel">
      <div class="card-head">Gestionnaire de connexion</div>

      <div class="pos-grid">
        <button class="pos-btn" data-pos="CTY" data-freq="118.800" onclick="selectPos(this)">
          <div class="pos-code">CTY</div>
          <div class="pos-name">City</div>
          <div class="pos-hz">118.800</div>
        </button>
        <button class="pos-btn" data-pos="WLD" data-freq="123.500" onclick="selectPos(this)">
          <div class="pos-code">WLD</div>
          <div class="pos-name">World</div>
          <div class="pos-hz">123.500</div>
        </button>
        <button class="pos-btn" data-pos="ARL" data-freq="124.615" onclick="selectPos(this)">
          <div class="pos-code">ARL</div>
          <div class="pos-name">Aerial</div>
          <div class="pos-hz">124.615</div>
        </button>
      </div>

      <div class="fg">
        <div class="fl">Callsign</div>
        <input class="fi" id="callsignInput" placeholder="KYKY_CTY" maxlength="12">
      </div>
      <div class="fg">
        <div class="fl">Entrée Micro</div>
        <select class="fi" id="inDev"></select>
      </div>
      <div class="fg" style="border-bottom:none;">
        <div class="fl">Sortie Audio</div>
        <select class="fi" id="outDev"></select>
      </div>

      <button class="conn-btn" id="connBtn" disabled onclick="toggleConn()">Se Connecter</button>
    </div>

    <!-- VHF Box -->
    <div class="vhf-box">
      <div class="vhf-top">
        <span class="vhf-brand">VHF COM — TRANSCEIVER</span>
        <span class="vhf-brand">KYKY-1000</span>
      </div>

      <div class="lcd-wrap">
        <div class="lcd-top">
          <div class="lcd-freq off" id="lcdFreq">---.---</div>
          <div class="lcd-unit">MHz</div>
        </div>
        <div class="lcd-pos" id="lcdPos">— NON CONNECTÉ —</div>
      </div>

      <div class="tx-banner" id="txBanner">● TX EN COURS</div>

      <div class="indics">
        <div class="indic">
          <div class="led led-r" id="ledExt"></div>
          <div class="led-lbl">EXT</div>
          <div class="led-who" id="extWho"></div>
        </div>
        <div class="indic">
          <div class="led led-g" id="ledVous"></div>
          <div class="led-lbl">VOUS</div>
        </div>
      </div>

      <div class="ptt-wrap">
        <button class="ptt-btn" id="pttBtn" disabled
          onmousedown="startPTT()" onmouseup="stopPTT()" onmouseleave="stopPTT()">
          PTT — APPUYER POUR ÉMETTRE
        </button>
        <div class="ptt-hint">ESPACE pour activer le PTT</div>
      </div>
    </div>

    <!-- Online Positions -->
    <div class="card online-panel">
      <div class="card-head">Positions en ligne</div>
      <div id="onlineList"><div class="no-ctrl">Aucun contrôleur connecté</div></div>
    </div>

  </div><!-- /main -->

  <!-- STATUS BAR -->
  <div class="statusbar">
    <div class="si"><div class="sdot" id="sdMic"></div><span id="sMic">Micro: —</span></div>
    <div class="si"><div class="sdot" id="sdConn"></div><span id="sConn">Déconnecté</span></div>
    <div class="si" style="margin-left:auto;font-size:10px;opacity:.35;"><span id="sUID"></span></div>
  </div>

</div><!-- /layout -->

<!-- Firebase SDKs (compat) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
// ══════════════════════════════════════════
//  FIREBASE INIT
// ══════════════════════════════════════════
const firebaseConfig = {
  apiKey: "AIzaSyDxDzLbCnqYYVknoyHMzbE0gB_SRVLpgiw",
  authDomain: "kyky-c3471.firebaseapp.com",
  databaseURL: "https://kyky-c3471-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "kyky-c3471",
  storageBucket: "kyky-c3471.firebasestorage.app",
  messagingSenderId: "658643330578",
  appId: "1:658643330578:web:758dc26d5504a503e39acb",
  measurementId: "G-245RE41YQK"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ══════════════════════════════════════════
//  IDENTITY
// ══════════════════════════════════════════
let uid = sessionStorage.getItem('atc_uid');
if (!uid) {
  uid = 'ATC_' + Math.random().toString(36).substr(2,8).toUpperCase();
  sessionStorage.setItem('atc_uid', uid);
}
document.getElementById('uidLabel').textContent = uid;
document.getElementById('sUID').textContent = 'UID: ' + uid;

// ══════════════════════════════════════════
//  STATE
// ══════════════════════════════════════════
let selPos = null, selFreq = null, callsign = '';
let connected = false;
let localStream = null;
let pttActive = false, pttLocked = false;
let inDevId = null, outDevId = null;

const peers = {};          // peerId → RTCPeerConnection
const audEls = {};         // peerId → HTMLAudioElement
const candQueues = {};     // peerId → [candidate]

let activeRefs = [];       // firebase refs to clean up

const STUN = { iceServers:[
  {urls:'stun:stun.l.google.com:19302'},
  {urls:'stun:stun1.l.google.com:19302'},
  {urls:'stun:stun2.l.google.com:19302'}
]};

// ══════════════════════════════════════════
//  DEVICES
// ══════════════════════════════════════════
async function loadDevices() {
  try {
    const s = await navigator.mediaDevices.getUserMedia({audio:true});
    s.getTracks().forEach(t => t.stop());
    const devs = await navigator.mediaDevices.enumerateDevices();
    const ins = devs.filter(d => d.kind==='audioinput');
    const outs = devs.filter(d => d.kind==='audiooutput');
    const inSel = document.getElementById('inDev');
    const outSel = document.getElementById('outDev');
    inSel.innerHTML = ins.map((d,i) => `<option value="${d.deviceId}">${d.label||'Micro '+(i+1)}</option>`).join('');
    outSel.innerHTML = outs.map((d,i) => `<option value="${d.deviceId}">${d.label||'Sortie '+(i+1)}</option>`).join('');
    inDevId = ins[0]?.deviceId;
    outDevId = outs[0]?.deviceId;
    inSel.onchange = () => { inDevId = inSel.value; };
    outSel.onchange = () => { outDevId = outSel.value; };
    document.getElementById('sdMic').classList.add('ok');
    document.getElementById('sMic').textContent = 'Micro: Prêt';
  } catch(e) {
    document.getElementById('sMic').textContent = 'Micro: Accès refusé';
  }
}

// ══════════════════════════════════════════
//  POSITION SELECTION
// ══════════════════════════════════════════
function selectPos(btn) {
  if (connected) return;
  document.querySelectorAll('.pos-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  selPos = btn.dataset.pos;
  selFreq = btn.dataset.freq;
  document.getElementById('lcdFreq').textContent = selFreq;
  document.getElementById('lcdFreq').classList.remove('off');
  document.getElementById('lcdPos').textContent = '— ' + selPos + ' —';
  const ci = document.getElementById('callsignInput');
  if (!ci.value) ci.value = 'KYKY_' + selPos;
  document.getElementById('connBtn').disabled = false;
}

// ══════════════════════════════════════════
//  CONNECT / DISCONNECT
// ══════════════════════════════════════════
async function toggleConn() {
  if (connected) { await doDisconnect(); } else { await doConnect(); }
}

async function doConnect() {
  callsign = (document.getElementById('callsignInput').value.trim().toUpperCase()) || ('KYKY_'+selPos);
  inDevId = document.getElementById('inDev').value;
  outDevId = document.getElementById('outDev').value;

  try {
    localStream = await navigator.mediaDevices.getUserMedia({
      audio: { deviceId: inDevId ? {exact:inDevId} : undefined, echoCancellation:true, noiseSuppression:true },
      video: false
    });
    localStream.getAudioTracks().forEach(t => t.enabled = false); // muted until PTT
  } catch(e) {
    alert('Impossible d\'accéder au microphone:\n' + e.message);
    return;
  }

  connected = true;
  setConnectedUI(true);

  const fk = freqKey(selFreq);

  // Controller presence
  const ctrlRef = db.ref('controllers/' + selPos);
  await ctrlRef.set({ uid, callsign, frequency: selFreq, online: true, ts: Date.now() });
  ctrlRef.onDisconnect().remove();
  activeRefs.push(ctrlRef);

  // Session member presence
  const memRef = db.ref(`sessions/${fk}/members/${uid}`);
  await memRef.set({ name: callsign, position: selPos, type: 'controller', ts: Date.now() });
  memRef.onDisconnect().remove();
  activeRefs.push(memRef);

  // Clear old signaling for us
  await db.ref(`signaling/${fk}/${uid}`).remove();

  // ── Listen for signaling addressed to me
  const sigRef = db.ref(`signaling/${fk}/${uid}`);
  sigRef.on('child_added', async snap => {
    const fromId = snap.key;
    const data = snap.val();
    if (!data) return;
    if (data.offer && !peers[fromId]) await handleOffer(fromId, data.offer, fk);
    if (data.answer && peers[fromId]) await handleAnswer(fromId, data.answer);
  });
  activeRefs.push(sigRef);

  // ── Listen for members on our frequency
  const allMemRef = db.ref(`sessions/${fk}/members`);
  allMemRef.on('child_added', async snap => {
    const pid = snap.key;
    if (pid === uid) return;
    if (peers[pid]) return;
    // larger UID initiates
    if (uid > pid) await initiateConn(pid, fk);
  });
  allMemRef.on('child_removed', snap => {
    killPeer(snap.key);
  });
  activeRefs.push(allMemRef);

  // ── Transmit state
  const txRef = db.ref(`sessions/${fk}/transmitting`);
  txRef.on('value', snap => handleTX(snap.val()));
  activeRefs.push(txRef);

  document.getElementById('sConn').textContent = callsign + ' @ ' + selFreq;
  document.getElementById('sdConn').classList.add('ok');
  document.getElementById('pttBtn').disabled = false;
}

async function doDisconnect() {
  stopPTT();

  const fk = freqKey(selFreq);

  // Clear Firebase presence + signaling
  await db.ref(`sessions/${fk}/members/${uid}`).remove();
  await db.ref(`controllers/${selPos}`).remove();
  await db.ref(`signaling/${fk}/${uid}`).remove();

  // Release TX if we held it
  const txSnap = await db.ref(`sessions/${fk}/transmitting`).get();
  if (txSnap.val()?.uid === uid) await db.ref(`sessions/${fk}/transmitting`).remove();

  // Detach all listeners
  activeRefs.forEach(r => r.off && r.off());
  activeRefs = [];

  // Close all peers
  Object.keys(peers).forEach(id => killPeer(id));

  // Stop media
  if (localStream) { localStream.getTracks().forEach(t => t.stop()); localStream = null; }

  connected = false;
  setConnectedUI(false);
  document.getElementById('sConn').textContent = 'Déconnecté';
  document.getElementById('sdConn').classList.remove('ok');
  document.getElementById('pttBtn').disabled = true;
}

// ══════════════════════════════════════════
//  WebRTC
// ══════════════════════════════════════════
async function initiateConn(pid, fk) {
  const pc = makePeer(pid, fk);
  localStream?.getTracks().forEach(t => pc.addTrack(t, localStream));
  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  await db.ref(`signaling/${fk}/${pid}/${uid}`).set({ offer: {type: offer.type, sdp: offer.sdp} });
}

async function handleOffer(pid, offer, fk) {
  const pc = makePeer(pid, fk);
  localStream?.getTracks().forEach(t => pc.addTrack(t, localStream));
  await pc.setRemoteDescription(new RTCSessionDescription(offer));
  // flush queued candidates
  for (const c of (candQueues[pid]||[])) {
    try { await pc.addIceCandidate(new RTCIceCandidate(c)); } catch(e){}
  }
  delete candQueues[pid];
  const answer = await pc.createAnswer();
  await pc.setLocalDescription(answer);
  await db.ref(`signaling/${fk}/${pid}/${uid}`).update({ answer: {type: answer.type, sdp: answer.sdp} });
}

async function handleAnswer(pid, answer) {
  const pc = peers[pid];
  if (!pc || pc.signalingState !== 'have-local-offer') return;
  await pc.setRemoteDescription(new RTCSessionDescription(answer));
}

function makePeer(pid, fk) {
  const pc = new RTCPeerConnection(STUN);
  peers[pid] = pc;

  pc.onicecandidate = e => {
    if (e.candidate) {
      db.ref(`signaling/${fk}/${pid}/${uid}/candidates`).push(e.candidate.toJSON());
    }
  };

  pc.ontrack = e => {
    let a = audEls[pid];
    if (!a) {
      a = new Audio(); audEls[pid] = a;
      if (outDevId && a.setSinkId) a.setSinkId(outDevId).catch(()=>{});
    }
    if (a.srcObject !== e.streams[0]) {
      a.srcObject = e.streams[0];
      a.play().catch(()=>{});
    }
  };

  pc.oniceconnectionstatechange = () => {
    if (['disconnected','failed','closed'].includes(pc.iceConnectionState)) killPeer(pid);
  };

  // Listen for candidates from peer
  const candRef = db.ref(`signaling/${fk}/${uid}/${pid}/candidates`);
  candRef.on('child_added', async snap => {
    const c = snap.val();
    if (peers[pid]?.remoteDescription) {
      try { await peers[pid].addIceCandidate(new RTCIceCandidate(c)); } catch(e){}
    } else {
      if (!candQueues[pid]) candQueues[pid] = [];
      candQueues[pid].push(c);
    }
  });
  activeRefs.push(candRef);

  return pc;
}

function killPeer(pid) {
  peers[pid]?.close();
  delete peers[pid];
  if (audEls[pid]) { audEls[pid].pause(); audEls[pid].srcObject = null; delete audEls[pid]; }
  delete candQueues[pid];
}

// ══════════════════════════════════════════
//  PTT
// ══════════════════════════════════════════
function startPTT() {
  if (!connected || pttLocked || pttActive) return;
  pttActive = true;
  localStream?.getAudioTracks().forEach(t => t.enabled = true);
  document.getElementById('pttBtn').classList.add('tx');
  document.getElementById('ledVous').classList.add('on');
  const fk = freqKey(selFreq);
  db.ref(`sessions/${fk}/transmitting`).set({ uid, name: callsign, pos: selPos, ts: Date.now() });
}

function stopPTT() {
  if (!pttActive) return;
  pttActive = false;
  localStream?.getAudioTracks().forEach(t => t.enabled = false);
  document.getElementById('pttBtn').classList.remove('tx');
  document.getElementById('ledVous').classList.remove('on');
  if (connected && selFreq) {
    const fk = freqKey(selFreq);
    db.ref(`sessions/${fk}/transmitting`).get().then(snap => {
      if (snap.val()?.uid === uid) db.ref(`sessions/${fk}/transmitting`).remove();
    });
  }
}

function handleTX(data) {
  const lExt = document.getElementById('ledExt');
  const lVous = document.getElementById('ledVous');
  const ptt = document.getElementById('pttBtn');
  const banner = document.getElementById('txBanner');
  const who = document.getElementById('extWho');

  if (data && data.uid !== uid) {
    lExt.classList.add('on');
    who.textContent = data.name || '?';
    pttLocked = true;
    ptt.classList.add('locked');
    banner.textContent = '● ' + (data.name || '?') + ' EN ÉMISSION';
    banner.classList.add('show');
    // force stop our own PTT if somehow active
    if (pttActive) stopPTT();
  } else if (data && data.uid === uid) {
    lVous.classList.add('on');
    lExt.classList.remove('on');
    who.textContent = '';
    banner.classList.remove('show');
  } else {
    lExt.classList.remove('on');
    lVous.classList.remove('on');
    who.textContent = '';
    pttLocked = false;
    ptt.classList.remove('locked');
    banner.classList.remove('show');
  }
}

// ══════════════════════════════════════════
//  UI UPDATES
// ══════════════════════════════════════════
function setConnectedUI(on) {
  const btn = document.getElementById('connBtn');
  const inputs = ['callsignInput','inDev','outDev'];
  if (on) {
    btn.textContent = 'Se Déconnecter'; btn.classList.add('disc');
    inputs.forEach(id => document.getElementById(id).disabled = true);
    document.querySelectorAll('.pos-btn').forEach(b => b.style.pointerEvents = 'none');
  } else {
    btn.textContent = 'Se Connecter'; btn.classList.remove('disc');
    inputs.forEach(id => document.getElementById(id).disabled = false);
    document.querySelectorAll('.pos-btn').forEach(b => b.style.pointerEvents = '');
    document.getElementById('lcdFreq').classList.add('off');
    document.getElementById('lcdPos').textContent = '— NON CONNECTÉ —';
    document.getElementById('ledExt').classList.remove('on');
    document.getElementById('ledVous').classList.remove('on');
    document.getElementById('txBanner').classList.remove('show');
    document.getElementById('extWho').textContent = '';
  }
}

const CTRL_DEFS = [
  {pos:'CTY', freq:'118.800', label:'City'},
  {pos:'WLD', freq:'123.500', label:'World'},
  {pos:'ARL', freq:'124.615', label:'Aerial'},
];

function buildOnlineList(data) {
  const list = document.getElementById('onlineList');
  const any = data && Object.values(data).some(v => v);
  if (!any) { list.innerHTML = '<div class="no-ctrl">Aucun contrôleur connecté</div>'; return; }
  list.innerHTML = CTRL_DEFS.map(def => {
    const c = data?.[def.pos];
    const on = !!c;
    return `<div class="pos-row">
      <div class="dot ${on?'on':''}"></div>
      <div class="row-info">
        <div class="row-call">${on ? c.callsign : def.pos}</div>
        <div class="row-detail">${def.label} · ${on?'En ligne':'Hors ligne'}</div>
      </div>
      <div class="freq-badge">${def.freq}</div>
    </div>`;
  }).join('');
}

// ══════════════════════════════════════════
//  HELPERS
// ══════════════════════════════════════════
function freqKey(f) { return f.replace('.','_'); }

// ══════════════════════════════════════════
//  KEYBOARD PTT
// ══════════════════════════════════════════
document.addEventListener('keydown', e => {
  if (e.code === 'Space' && !e.repeat && connected) { e.preventDefault(); startPTT(); }
});
document.addEventListener('keyup', e => {
  if (e.code === 'Space') { e.preventDefault(); stopPTT(); }
});

// ══════════════════════════════════════════
//  UNLOAD CLEANUP
// ══════════════════════════════════════════
window.addEventListener('beforeunload', () => {
  if (!connected) return;
  const fk = freqKey(selFreq);
  db.ref(`sessions/${fk}/members/${uid}`).remove();
  db.ref(`signaling/${fk}/${uid}`).remove();
  db.ref('controllers/' + selPos).remove();
});

// ══════════════════════════════════════════
//  INIT
// ══════════════════════════════════════════
loadDevices();
db.ref('controllers').on('value', snap => buildOnlineList(snap.val()));
</script>
</body>
</html>
